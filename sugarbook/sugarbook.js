function log(a){if(1){console.log(a)}}var m={top:15,right:10,bottom:4,left:30},strip_w=900,strip_h=50,strip_eh=75,highlight_w=2,w=strip_w+m.right+m.left+highlight_w*2,h=strip_h+m.top+m.bottom+highlight_w*2,dscale=d3.scale.linear().domain([0,24]).range([0,strip_w]);var tooltip=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").text("a simple tooltip");tooltip.locked=false;function tooltip_travel(){var b=(d3.event.pageY-10)+"px";var a=(d3.event.pageX+10)+"px";tooltip.style("top",b).style("left",a)}function tooltip_enable(a,b){if(!tooltip.locked){tooltip.text(b);tooltip.style("visibility","visible");tooltip.item=a;a.attr("stroke","white");tooltip_travel()}}function tooltip_disable(){if(!tooltip.locked){tooltip.style("visibility","hidden");tooltip.item.attr("stroke","none");tooltip.item=undefined}}function tooltip_lock(){tooltip.locked=true}function tooltip_unlock(){tooltip.locked=false}function tooltip_break_lock(){if(tooltip.locked){tooltip.locked=false;tooltip_disable()}}var minDate;var maxDate;function note_date(a){if(minDate==undefined){minDate=maxDate=a}else{if(a.getTime()<minDate.getTime()){minDate=midnight(a)}else{if(a.getTime()>maxDate.getTime()){maxDate=a}}}}var pump_data={};function add_pump_data(a){for(i in a){r=a[i];t=new Date(r.time);note_date(t);tmidnight=d3.time.day(t);dd=pump_data[tmidnight];if(dd==undefined){dd=pump_data[tmidnight]={BG:[],carbs:[],basal:[],bolus:[]}}if(r.bg!=undefined&&r.bg!=""){dd.BG.push({x:t,y:r.bg})}if(r.carbs!=undefined&&r.carbs!=""){dd.carbs.push({x:t,y:r.carbs})}if(r.basal!=undefined&&r.basal!=""){dd.basal.push({x:t,y:r.basal})}if(r.bolus!=undefined&&r.bolus!=""){dd.bolus.push({x:t,y:r.bolus})}}}var day_of_week={0:"Sun",1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat"};var month_of_year={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"};function day_postfix(a){if((a>=4&&a<=20)||(a>=24&&a<=30)){return"th"}m=a%10;if(m==1){return"st"}if(m==2){return"nd"}return"rd"}function friendly_date(b){var a=b.getDate();return day_of_week[b.getDay()]+"-"+a+day_postfix(a)}function friendly_date2(a){return day_of_week[a.getDay()]+" "+month_of_year[a.getMonth()]+" "+a.getDate()}function friendly_date3(a){return(a.getMonth()+1)+"/"+a.getDate()+"/"+a.getFullYear()}function hsvToRgb(k,z,x){var a,l,u;var j=Math.floor(k*6);var o=k*6-j;var e=x*(1-z);var d=x*(1-o*z);var y=x*(1-(1-o)*z);switch(j%6){case 0:a=x,l=y,u=e;break;case 1:a=d,l=x,u=e;break;case 2:a=e,l=x,u=y;break;case 3:a=e,l=d,u=x;break;case 4:a=y,l=e,u=x;break;case 5:a=x,l=e,u=d;break}return[a*255,l*255,u*255]}function format_time(f){var e=f.getHours();var a=f.getMinutes();if(a<10){a="0"+a}var b;if(e==12){b="pm"}else{if(e>12){b="pm";e-=12}else{if(e==0){e=12}b="am"}}return e+":"+a+b}function format_time_data(a){return a.y+" @ "+format_time(a.x)}function format_time_insulin_data(a){return parseFloat(a.y)+"u @ "+format_time(a.x)}function format_time_basal_data(e,a){var b=e.x;var d=a.x;s=parseFloat(e.y)+"u/hr "+format_time(b)+" to "+format_time(d);return s}function format_time_carb_data(a){return a.y+"g @ "+format_time(a.x)}function bg_to_class(a){if(a<50){return"low-urgent"}if(a<60){return"low-attention"}if(a<70){return"low"}if(a<180){return"neutral"}if(a<250){return"high"}if(a<300){return"high-attention"}return"high-urgent"}function bg_to_color(j){var g,f,a;if(j<80){var d=(j-40)/(80-40);if(d<0){d=0}var e=d3.scale.pow().exponent(2).range([240/360,120/360]);g=e(d);f=1-d*0.3;a=0.9}else{if(j<250){var d=(j-80)/(250-80);if(d<0){d=0}var e=d3.scale.pow().exponent(0.5).range([120/360,0/360]);g=e(d);f=0.7;a=0.9}else{if(j>=300){return d3.rgb(255,0,255)}var d=(j-250)/(300-250);if(d<0){d=0}g=0;f=0.7+d*0.28;a=0.9+d*0.1}}rgb=hsvToRgb(g,f,a);return d3.rgb(rgb[0],rgb[1],rgb[2])}function bg_to_radius(a){if(a<80){return bg_to_radius(80)}if(a>350){a=350}return 8+Math.sqrt((a-80)/500*80)}function midnight(a){return d3.time.day(a)}function get_hour(b){var a=b.getTime()-midnight(b).getTime();return a/(1000*60*60)}function add_days(a,d){var b=new Date;b.setTime(a.getTime()+d*1000*24*3600);return b}var daylight=[0,1,2,3,4,5,9,14,16,17,18,20,22,20,18,17,16,14,9,5,4,3,2,1];function hour_to_color(d){var a=150;var b=20;weight=daylight[Math.floor(d)]/24;var e=Math.floor(weight*(a-b))+b;return d3.rgb(e,e,e)}var deselect_timer=undefined;function cancel_deselect_timer(){if(deselect_timer!=undefined){clearTimeout(deselect_timer);deselect_timer=undefined}}function set_deselect_timer(){cancel_deselect_timer();deselect_timer=setTimeout("trigger_deselect_timer()",500)}function trigger_deselect_timer(){if(selected!=undefined){deselect(selected)}}var selected=undefined;function deselect(a){c=d3.event;d3.select(a).selectAll(".border").style("visibility","hidden");d3.select(a).selectAll(".separator").attr("visibility","hidden");expand(a,strip_h);d3.select(a).selectAll(".carbs, .bolus").style("visibility","hidden");selected=undefined;d3.selectAll(".basal").remove()}function expand(d,a){var b=d.parentElement;d3.select(b).attr("height",a+2*highlight_w+m.top+m.bottom)}var yscale=d3.scale.linear().domain([0,2]).range([strip_h+strip_eh,strip_h]);var basal_area=d3.svg.area().x(function(a){return dscale(get_hour(a.x))}).y0(yscale(0)).y1(function(a){return yscale(a.y)}).interpolate("step-after");var basal_area_zero=d3.svg.area().x(function(a){return dscale(get_hour(a.x))}).y0(yscale(0)).y1(yscale(0)).interpolate("step-after");var basal_line=d3.svg.line().x(function(a){return dscale(get_hour(a.x))}).y(function(a){return yscale(a.y)}).interpolate("step-after");function largest_hour_smaller_than(e,a){var b=0;while(b<e.length){var d=get_hour(e[b].x);if(d>a){return b-1}b=b+1}return e.length}function basal_invert(d,a){var b=largest_hour_smaller_than(d,a);if(b<0||b>=d.length){return undefined}return[d[b],d[b+1]]}function basal_graph(b){pts=pump_data[b.__data__].basal;if(pts.length==0){return}var a=d3.select(b);var d=a.append("svg:path").attr("class","basal").attr("fill","lightblue").attr("opacity","0.6").attr("d",basal_area_zero(pts)).on("mousemove",function(l,f){var e=d3.svg.mouse(b);var j=e[0];hour=j/strip_w*24;span=basal_invert(pts,hour);var g=d3.select(this);var k=format_time_basal_data(span[0],span[1]);tooltip_enable(g,k)}).on("mouseup",function(f,e){tooltip_unlock()}).on("mouseout",function(f,e){tooltip_disable()});a.append("svg:path").attr("class","basal").attr("stroke","white").attr("fill","none").attr("d",basal_line(pts));d.transition().attr("d",basal_area(pts))}var shake_item=undefined;var shake_dx=1;function stop_shaking(){shaking=false}function shake_me_more(){shake_dx=-shake_dx;var a=shake_item;if(shaking){dx=shake_dx}else{dx=0}d3.select(a).attr("cx",dscale(get_hour(a.__data__.x))+shake_dx);if(shaking){shake_me(a)}else{shake_item=undefined}}function shake_me(b){if(shake_item!=undefined&&shake_item!=b){var a=dscale(get_hour(shake_item.__data__.x));d3.select(shake_item).attr("cx",a)}shake_item=b;shaking=true;setTimeout(function(){shake_me_more()},40)}function shake_me_no(){shaking=false}function add_basal_endpoints(g){n=g.length;if(n==0){return}var e=24-1/3600;var a=g[n-1].x;if(get_hour(a)<e){var b=midnight(a).getTime()+(24*60*60*1000)-1;var f=new Date;f.setTime(b);g.push({x:f,y:g[n-1].y})}}function data_ready(){for(var b in pump_data){add_basal_endpoints(pump_data[b].basal)}var d=maxDate;var a=add_days(d,-7*4);if(a.getTime()<minDate.getTime()){a=minDate}draw_strips(a,d);sInput=d3.select("#startDateInput");sInput.attr("value",friendly_date3(a));eInput=d3.select("#endDateInput");eInput.attr("value",friendly_date3(d));msg=d3.select("#rangeMessage");msg.text("Available data is from "+friendly_date3(minDate)+" to "+friendly_date3(maxDate)+"...")}function setDates(){sInput=d3.select("#startDateInput");eInput=d3.select("#endDateInput");sdate=new Date(sInput[0][0].value);edate=new Date(eInput[0][0].value+" 00:01");if(sdate=="Invalid Date"||edate=="Invalid Date"){alert("Invalid Date")}else{if(sdate.getTime()<minDate.getTime()){sdate=minDate;sInput[0][0].value=friendly_date3(sdate);alert("earliest available data starts on "+friendly_date3(sdate))}else{if(edate.getTime()>maxDate.getTime()){edate=maxDate;eInput[0][0].value=friendly_date3(edate);alert("latest available data ends on "+friendly_date3(edate))}}draw_strips(sdate,edate)}}function draw_strips(a,d){dateRange=d3.time.days(a,d);d3.select("#main-view").selectAll("svg").remove();svg=d3.select("#main-view").selectAll("svg").data(dateRange).enter().append("svg").on("mousedown",function(g,f){if(tooltip.item!=undefined){tooltip_lock()}}).on("mouseup",function(g,f){tooltip_break_lock()}).on("mousemove",function(g,f){tooltip_travel()}).attr("width",w).attr("height",h).attr("class","RdYlGn").append("g").attr("class","day-strip").attr("transform","translate("+(m.left+highlight_w)+","+(m.top+highlight_w)+")").on("mouseover",function(g,f){cancel_deselect_timer();if(this==selected){return}if(selected!=undefined){deselect(selected)}selected=this;expand(this,strip_h+strip_eh);d3.select(this).selectAll(".border").style("visibility","visible");d3.select(this).selectAll(".separator").attr("visibility","visible");basal_graph(this);d3.select(this).selectAll(".carbs").style("visibility","visible").attr("height",2).transition().attr("height",function(j){return j.y/100*strip_h});d3.select(this).selectAll(".bolus").style("visibility","visible").attr("height",2).attr("y",strip_h-2).transition().attr("height",function(j){return j.y/10*strip_h}).attr("y",function(j){return strip_h-(j.y/10*strip_h)})}).on("mouseout",function(g,f){set_deselect_timer()}).on("mousedown",function(g,f){});d3.selectAll(".day-strip").append("rect").style("visibility","hidden").attr("class","border").attr("x",-highlight_w).attr("y",-highlight_w).attr("width",strip_w+highlight_w*2).attr("height",strip_h+strip_eh+highlight_w*2).attr("fill","#eee");svg.append("text").attr("x",-m.left+3).attr("y",-5).attr("text-anchor","start").map(friendly_date2).text(String);var b=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23];d3.selectAll(".day-strip").selectAll("hour-shades").data(b).enter().append("rect").attr("class","shade").attr("x",function(f){return dscale(f)}).attr("y",0).attr("width",dscale(1)-dscale(0)).attr("height",strip_h+strip_eh).attr("stroke",function(f){return hour_to_color(f)}).attr("fill",function(f){return hour_to_color(f)});svg.append("line").attr("class","separator").attr("x1",dscale(0)).attr("y1",strip_h+1).attr("x2",dscale(24)).attr("y2",strip_h+1).attr("opacity",0.5).attr("stroke","#000").attr("visibility","hidden");d3.selectAll(".day-strip").selectAll("BGs").data(function(f){return pump_data[f].BG}).enter().append("circle").attr("class","BG").attr("bg-class",function(f){return bg_to_class(f.y)}).attr("cx",function(f){return dscale(get_hour(f.x))}).attr("cy",strip_h*0.5).attr("r",function(f){return bg_to_radius(f.y)}).attr("fill",function(g,f){return bg_to_color(g.y)}).on("mouseover",function(j,f){var g=d3.select(this);tooltip_enable(g,format_time_data(this.__data__));if(this.__data__.y<70){shake_me(this)}}).on("mouseup",function(g,f){tooltip_unlock()}).on("mouseout",function(g,f){tooltip_disable();stop_shaking()});var e=8;d3.selectAll(".day-strip").selectAll("carbs").data(function(f){return pump_data[f].carbs}).enter().append("rect").attr("class","carbs").attr("x",function(f){return dscale(get_hour(f.x))-e/2}).attr("y",0).attr("width",e).attr("height",function(f){return f.y/100*strip_h}).attr("fill","lightpink").attr("opacity","0.6").style("visibility","hidden").on("mouseover",function(g,f){rect=d3.select(this);tooltip_enable(rect,format_time_carb_data(this.__data__))}).on("mouseup",function(g,f){tooltip_unlock()}).on("mouseout",function(g,f){tooltip_disable()});d3.selectAll(".day-strip").selectAll("bolus").data(function(f){return pump_data[f].bolus}).enter().append("rect").attr("class","bolus").attr("x",function(f){return dscale(get_hour(f.x))-e/2}).attr("y",function(f){return strip_h-(f.y/10*strip_h)}).attr("width",e).attr("height",function(f){return f.y/10*strip_h}).attr("fill","lightblue").attr("opacity","0.8").style("visibility","hidden").on("mouseover",function(j,f){var g=d3.select(this);tooltip_enable(g,format_time_insulin_data(this.__data__))}).on("mouseup",function(g,f){tooltip_unlock()}).on("mouseout",function(g,f){tooltip_disable()})}d3.csv("./pump-data-bg.csv",function(a){add_pump_data(a);d3.csv("./pump-data-insulin.csv",function(b){add_pump_data(b);data_ready()})});
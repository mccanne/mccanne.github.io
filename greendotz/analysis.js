function draw_sugar_graph(r,m,l,t,q,u,A,j,B,i,c,s){var w=A.xrange.min;var f=A.xrange.max;var e=r.append("rect").attr("x",m).attr("y",l).attr("width",t).attr("height",q).attr("fill","lightgray").attr("opacity",0.75);for(k in j){var b=j[k];r.append("svg:line").attr("x1",A.xscale(w)).attr("y1",A.yscale(b)).attr("x2",A.xscale(f)).attr("y2",A.yscale(b)).attr("opacity",0.6).attr("stroke-dasharray","3,1").attr("stroke","#555");r.append("svg:text").attr("x",A.xscale(w)).attr("y",A.yscale(b)).attr("dy","-0.4em").attr("opacity",0.8).attr("fill","#333").attr("stroke","none").attr("font-size","75%").text(b)}var o=r.append("svg:text").attr("x",A.xscale(f)).attr("y",A.yscale(A.yrange.max)).attr("fill","#444").attr("stroke","none").attr("font-size","90%").attr("text-anchor","end").text(B);var n=parseInt(o.style("height"));var h=first_of_months_between(w,f);for(k in h){var z=h[k];var g=month_of_year[z.getMonth()];r.append("svg:text").attr("x",A.xscale(z)).attr("y",A.yscale(A.yrange.min)).attr("dy","1.5em").attr("fill","#333").attr("stroke","none").attr("font-size","75%").attr("text-anchor","middle").text(g)}i(r);var v=r.append("svg:line").attr("class","mini-highlighter").attr("x1",A.xscale(w)).attr("y1",A.yscale(j[0])).attr("x2",A.xscale(w)).attr("y2",A.yscale(j[j.length-1])).attr("opacity",0.8).attr("stroke-dasharray","3,1").attr("stroke-width","1.5px").attr("stroke","black").attr("visibility","hidden");var a=r.append("svg:circle").attr("class","mini-highlighter").attr("cx",A.xscale(w)).attr("cy",A.yscale(A.yrange.min)).attr("r",3).attr("opacity",0.8).attr("stroke","black").attr("fill","none").attr("visibility","hidden");var p=r.append("rect").attr("class","top-highlighter").attr("x",m).attr("y",l).attr("width",t).attr("height",q).attr("opacity",0);p.update_highlighter=function(C){return;v.attr("visibility","visible");var d=A.xscale(C);v.attr("x1",d);v.attr("x2",d);a.attr("cx",d);var D=c[midnight(C)];var E=D.y;if(E==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",A.yscale(E))}};p.on("dblclick",function(G,D){log("DOUBLE");var C=d3.svg.mouse(this);var F=C[0];var y=A.xscale.invert(F);var E=new Date();E.setTime(y);log(E);build_dashboard();view_set_date(E);dbd.click_to_detailed(noon(E))});p.on("mouseout",function(y,x){e.attr("stroke","none");d3.selectAll(".mini-highlighter").attr("visibility","hidden")});p.on("mousemove",function(I,F){e.attr("stroke","black");return;var D=d3.svg.mouse(this);var H=D[0];var C=A.xscale.invert(H);var G=new Date();G.setTime(C);var E;for(E in all_graphs){all_graphs[E].update_highlighter(G)}return;d3.selectAll(".top-highlighter").each(function(M,L){log(G);var K=A.xscale(G);v.attr("x1",K);v.attr("x2",K);a.attr("cx",K);var N=c[midnight(G)].y;if(N==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",A.yscale(N))}});return;var C=A.xscale(G);v.attr("x1",C);v.attr("x2",C);a.attr("cx",C);var J=c[midnight(G)].y;if(J==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",A.yscale(J))}})}function build_sugar_scale(j,i,c,m,l,d){var g=daterange.edate;var e=d3.time.day.offset(g,-90);var b=10;var a=d3.scale.linear().domain([e,g]).range([j+b,j+c-b]);var h={min:l,max:d};var f=d3.scale.linear().domain([h.min,h.max]).range([i+m*0.85,i+m*0.15]);return{xscale:a,yscale:f,xrange:{min:e,max:g},yrange:h}}function sugar_graph(e,m,l,a,o){var b=40;var f=350;var c=build_sugar_scale(m,l,a,o,b,f);var j=telemetry.selectBGs(c.xrange.min,c.xrange.max);var i=telemetry.mean_BG(c.xrange.min,c.xrange.max);var q=telemetry.dev_up_BG(c.xrange.min,c.xrange.max);var n=telemetry.dev_down_BG(c.xrange.min,c.xrange.max);var h=d3.svg.line().x(function(r){return c.xscale(r.x)}).y(function(r){return c.yscale(r.y)}).interpolate("linear");var d=[50,100,150,200,250,300];var g=function(s){s.append("svg:path").attr("class","bg_analysis").attr("stroke","black").attr("fill","none").attr("opacity",0.8).attr("d",h(i));s.append("svg:path").attr("class","bg_analysis").attr("stroke","darkgray").attr("fill","none").attr("opacity",0.8).attr("d",h(q));s.append("svg:path").attr("class","bg_analysis").attr("stroke","darkgray").attr("fill","none").attr("opacity",0.8).attr("d",h(n));var u=[];var r;for(r=0;r<q.length;++r){u.push({x:q[r].x,y0:n[r].y,y1:q[r].y})}log(u);var t=d3.svg.area().x(function(v){return c.xscale(v.x)}).y0(function(v){return(c.yscale(v.y0))}).y1(function(v){return(c.yscale(v.y1))}).interpolate("linear");s.append("svg:path").attr("class","sugar_dev").attr("fill","lightblue").attr("opacity","0.75").attr("d",t(u))};var p=map_ts_to_array(i);draw_sugar_graph(e,m,l,a,o,"gray",c,d,"sugar trend",g,p,"Sugar");e.selectAll(".aBGs").data(j).enter().append("circle").attr("cx",function(r){return c.xscale(r.x)}).attr("cy",function(r){return c.yscale(Math.min(r.y,f))}).attr("r",4).attr("opacity","0.25").attr("fill",function(s,r){return bg_to_simple_color2(s.y)})}function ts_layers(){var e=daterange.edate;var b=d3.time.day.offset(e,-90);var h=telemetry.basal_usage(b,e);var f=telemetry.bolus_usage(b,e);var d=telemetry.carb_consumption(b,e);var g=telemetry.mean_BG(b,e);var c=[];c[0]=[];c[1]=[];c[2]=[];c[3]=[];for(k=0;k<91;++k){c[0][k]={x:k,y:h[k].y};c[1][k]={x:k,y:f[k].y};c[2][k]={x:k,y:d[k].y/10};c[3][k]={x:k,y:g[k].y/10}}return c}function lame_stream_graph(i,l,j,p,g){var c=10,d=91,f=d3.layout.stack().offset("wiggle")(ts_layers()),e=["lightblue","blue","lightpink","lightgreen"];var q=d-1,o=d3.max(f,function(h){return d3.max(h,function(m){return m.y0+m.y})});var b=d3.svg.area().x(function(h){return h.x*p/q}).y0(function(h){return g-h.y0*g/o}).y1(function(h){return g-(h.y+h.y0)*g/o});var a=i.append("svg").attr("x",l).attr("y",j).attr("width",p).attr("height",g);a.selectAll("path").data(f).enter().append("path").style("fill",function(m,h){return e[h]}).style("opacity","0.75").attr("d",b)}function draw_analysis(){var d=2;var a=40;var c=400;var b=d3.select("#analysis").append("svg").attr("width",920).attr("height",d*c+4);b.append("rect").attr("x",2).attr("y",2).attr("width",916).attr("height",d*c).attr("fill","#f5f5f5");b.append("text").attr("x",15).attr("y",32).attr("font-weight","bold").attr("font-size","165%").text("various analysis visuations (work in progress)");sugar_graph(b,2,a,916,c)};
telemetry={};telemetry.note_date=function(a){if(this.minDate==undefined){this.minDate=this.maxDate=a}else{if(a.getTime()<this.minDate.getTime()){this.minDate=midnight(a)}else{if(a.getTime()>this.maxDate.getTime()){this.maxDate=a}}}};telemetry.add_pump_data=function(b){for(i in b){r=b[i];t=new Date(r.time);if(r.cbg!=undefined&&r.cbg!=""){t=add_days(t,-34)}this.note_date(t);tmidnight=midnight(t);var a=this.pump_data[tmidnight];if(a==undefined){a={BG:[],carbs:[],basal:[],bolus:[],cBG:[]};this.pump_data[tmidnight]=a}if(r.bg!=undefined&&r.bg!=""){a.BG.push({x:t,y:r.bg})}if(r.carbs!=undefined&&r.carbs!=""){a.carbs.push({x:t,y:r.carbs})}if(r.basal!=undefined&&r.basal!=""){a.basal.push({x:t,y:r.basal})}if(r.bolus!=undefined&&r.bolus!=""){a.bolus.push({x:t,y:r.bolus})}if(r.cbg!=undefined&&r.cbg!=""){a.cBG.push({x:t,y:r.cbg})}}};function add_days(a,c){var b=new Date;b.setTime(a.getTime()+c*1000*24*3600);return b}telemetry.selectBGs=function(a,c){var f=midnight(c).getTime();var b=a;var d=[];while(b.getTime()<=f){dd=this.pump_data[b];if(dd!=undefined){for(k in dd.BG){d.push(dd.BG[k])}}b=add_days(b,1)}return d};telemetry.selectCarbs=function(a,c){var f=midnight(c).getTime();var b=a;var d=[];while(b.getTime()<=f){dd=this.pump_data[b];if(dd!=undefined){for(k in dd.carbs){d.push(dd.carbs[k])}}b=add_days(b,1)}return d};telemetry.selectBasal=function(a,c){var f=midnight(c).getTime();var b=a;var d=[];while(b.getTime()<=f){dd=this.pump_data[b];if(dd!=undefined){for(k in dd.basal){d.push(dd.basal[k])}}b=add_days(b,1)}return d};telemetry.selectBolus=function(a,c){var f=midnight(c).getTime();var b=a;var d=[];while(b.getTime()<=f){dd=this.pump_data[b];if(dd!=undefined){for(k in dd.bolus){d.push(dd.bolus[k])}}b=add_days(b,1)}return d};telemetry.selectCBGs=function(a,c){var f=midnight(c).getTime();var b=a;var d=[];while(b.getTime()<=f){dd=this.pump_data[b];if(dd!=undefined){for(k in dd.cBG){d.push(dd.cBG[k])}}b=add_days(b,1)}return d};telemetry.process_file=function(a){this.add_pump_data(a);this.nread+=1;if(this.nread>=this.nfiles){this.callback()}};telemetry.load=function(a,c){this.pump_data={};this.callback=c;this.nfiles=a.length;this.nread=0;var b=this;for(fname in a){d3.csv(a[fname],function(d){b.process_file(d)})}};telemetry.find_smallest_causal_pt=function(a,c){var b;for(b in c){if(c[b].x>=a){return b}}return -1};telemetry.find_isolated_highs=function(b,d,o){ts=[];var e;for(e in b){var f=b[e].y;if(f<180){continue}var h=b[e].x;var l=this.find_smallest_causal_pt(h,o);if(l<0){continue}var g=o[l].x;var a=d3.time.minute.offset(h,15);if(g>a){continue}var n=d3.time.minute.offset(h,-15);var m=this.find_smallest_causal_pt(n,d);if(m>=0){var c=d[m].x;if(c>n&&c<a){continue}}ts.push([e,l])}return ts};telemetry.find_covered_carbs=function(a,c,e){ts=[];var b;var g;for(b in c){var f=c[b].x;var d=this.find_smallest_causal_pt(f,e);if(f.getTime()==e[d].x.getTime()&&e[d].y>0){ts.push([b,d])}}return ts};var electra_program_jun2012=[{x:0,y:0.7},{x:2,y:0.65},{x:4,y:0.675},{x:5,y:0.75},{x:6,y:0.8},{x:9,y:0.7},{x:10,y:0.65},{x:13,y:0.725},{x:15,y:0.8},{x:17,y:0.75},{x:20,y:0.8},{x:23,y:0.725}];function basal_by_hour(a,c){var d=get_hour(a);var b;for(b=1;b<c.length;b+=1){if(d<c[b].x){return c[b-1].y}}return c[c.length-1].y}function basal_prev_by_hour(a,c){var d=get_hour(a);var b;for(b=0;b<c.length;b+=1){if(c[b].x>=d){if(b==0){return c[0].y}return c[b-1].y}}return c[c.length-1].y}function find_next_deviation(e,d,b){var f=d.length;while(e<f){var c=d[e].y;var a=basal_by_hour(d[e].x,b);if(c!=a){return e}e+=1}return -1}function find_next_conformance(e,d,b){var f=d.length;while(e<f){var c=d[e].y;var a=basal_by_hour(d[e].x,b);if(c==a){return e}e+=1}return -1}telemetry.find_temp_basals=function(f,b){var m=[];var a=b.length;var c=0;while(1){var o=find_next_deviation(c,b,f);if(o<0){return m}var d=find_next_conformance(o,b,f);var h=d;if(h<0){h=b.length-1}var e;var p=[];for(e=o;e<=h;e+=1){var l=b[e].x;var g=basal_prev_by_hour(l,f);p.push({actual:b[e],program:g})}m.push(p);if(d<0){return m}c=h}return m};telemetry.mean_BG_2wk=function(c){var d=0;var f=0;var b=1000;var e=0;c=midnight(c);for(k=0;k<14;++k){var a=d3.time.day.offset(c,-k);dd=this.pump_data[a];if(dd!=undefined){for(j in dd.BG){bg=parseFloat(dd.BG[j].y);d+=bg;f+=1;if(bg>e){e=bg}if(bg<b){b=bg}}}}if(f==0){return undefined}return{mean:(d/f),max:e,min:b}};telemetry.mean_dev_BG_2wk=function(d,b){var a={s:0,n:0};var e={s:0,n:0};d=midnight(d);for(k=0;k<14;++k){var c=d3.time.day.offset(d,-k);dd=this.pump_data[c];if(dd!=undefined){for(j in dd.BG){bg=parseFloat(dd.BG[j].y);if(bg>b){a.s+=bg-b;a.n+=1}if(bg<b){e.s+=bg-b;e.n+=1}}}}if(a.n==0){return undefined}return{updev:(a.s/a.n),downdev:(e.s/e.n),mean:b}};telemetry.mean_BG=function(b,d){var e=[];var c=midnight(b);while(c<=d){var a=this.mean_BG_2wk(c);if(a!=undefined){e.push({x:c,y:a.mean,min:a.min,max:a.max})}c=d3.time.day.offset(c,1)}return e};telemetry.dev_up_BG=function(b,d){var e=[];var c=midnight(b);while(c<=d){var f=this.mean_BG_2wk(c);var a=this.mean_dev_BG_2wk(c,f.mean);if(a!=undefined){e.push({x:c,y:(a.mean+a.updev)})}c=d3.time.day.offset(c,1)}return e};telemetry.dev_down_BG=function(b,d){var e=[];var c=midnight(b);while(c<=d){var f=this.mean_BG_2wk(c);var a=this.mean_dev_BG_2wk(c,f.mean);if(a!=undefined){e.push({x:c,y:(a.mean+a.downdev)})}c=d3.time.day.offset(c,1)}return e};telemetry.carb_consumption=function(a,d){var g=[];var b=midnight(a);var c=20000;var f=0;while(b<=d){var e=0;dd=this.pump_data[b];if(dd!=undefined){for(j in dd.carbs){carbs=parseFloat(dd.carbs[j].y);e+=carbs;if(carbs>f){f=carbs}if(carbs<c){c=carbs}}}g.push({x:b,y:e});b=d3.time.day.offset(b,1)}return g};telemetry.bolus_usage=function(a,c){var e=[];var b=midnight(a);while(b<=c){var d=0;dd=this.pump_data[b];if(dd!=undefined){for(j in dd.bolus){d+=parseFloat(dd.bolus[j].y)}}e.push({x:b,y:d});b=d3.time.day.offset(b,1)}return e};telemetry.basal_usage=function(a,d){var l=[];var c=midnight(a);while(c<=d){var g=0;var f=0;var e=0;dd=this.pump_data[c];if(dd!=undefined){for(j in dd.basal){var b=get_hour(dd.basal[j].x);g+=(b-f)*e;f=b;e=dd.basal[j].y}}g+=(24-f)*e;l.push({x:c,y:g});c=d3.time.day.offset(c,1)}return l};
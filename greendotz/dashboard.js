dbd={};var daylight=[0,1,2,3,4,5,9,14,16,17,18,20,22,20,18,17,16,14,9,5,4,3,2,1];dbd.hour_to_color=function(c){var a=150;var b=20;var d=daylight[Math.floor(c)]/24;var e=Math.floor(d*(a-b))+b;return d3.rgb(e,e,e)};dbd.new_hour_to_color=function(c){var d=[0,0.1,0.1,0.1,0.1,0.2,0.4,0.6,0.7,0.9,0.95,1,1,1,1,0.95,0.9,0.7,0.6,0.4,0.2,0.1,0.1,0.1,0.1,];var a=190;var b=50;d=daylight[Math.floor(c)]/24;var e=Math.floor(d*(a-b))+b;return d3.rgb(e,e,e)};dbd.draw_gray_spacer=function(){var a="#f5f5f5";this.inner.selectAll("spacers").data([0,this.vw+this.pad*2-this.pad]).enter().append("rect").style("z-index","9").attr("class","gray-spacer").attr("x",function(b){return b}).attr("y","0").attr("width",this.pad).attr("height",this.vh).attr("fill","blue").attr("visibility","hidden")};dbd.spacer_on=function(){d3.selectAll(".spacers").attr("visibility","visible")};dbd.spacer_off=function(){d3.selectAll(".spacers").attr("visibility","hidden")};dbd.draw_ramp=function(){var i=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23];var a=this.vis;var c=this.xscale_day;var l=this.hour_to_color;var d=midnight(this.sdate);var b=d3.time.hour.offset(d,1);var j=c(b)-c(d);var f=this.vh;var g=24*14;for(hour=0;hour<g;++hour){var e=this.hour_to_color(hour%24);a.append("rect").attr("class","shade").attr("x",c(d3.time.hour.offset(d,hour))).attr("y",0).attr("width",j).attr("height",f).attr("stroke",e).attr("fill",e)}};dbd.remove_y_legend=function(){this.vis.selectAll(".y_legend").remove()};dbd.draw_time_legend=function(){var c=24*14;var d=this.time_legend;var b;var a=this.sdate;for(b=0;b<c;b+=3){var f=d3.time.hour.offset(a,b);var e=d.append("text");e.attr("x",this.xscale_day(f)).attr("y",26).attr("font-size","90%").attr("text-anchor","middle").text(hour_to_string(b));if((b%24)==0){e.attr("class","detailed_label")}else{e.attr("class","grabbable-time")}}for(b=12;b<c;b+=24){var f=d3.time.hour.offset(a,b);d.append("text").attr("class","detailed_label").attr("x",this.xscale_day(f)).attr("y",10).attr("font-size","90%").attr("text-anchor","middle").text(weekday(f)+" "+friendly_date3(f))}};dbd.set_pan=function(a,b){a+=this.pad;if(b){d3.select("#pan-window").transition().duration(250).attr("transform",fmt_translate(a,0));d3.select("#time-panner").transition().duration(250).attr("transform",fmt_translate(a,0))}else{d3.select("#pan-window").attr("transform",fmt_translate(a,0));d3.select("#time-panner").attr("transform",fmt_translate(a,0))}};function dbd_dragmove(c,b){if(dbd.mode!="detail"){return}var a=d3.event.dx;dbd.shift_viewer_pixels(a,false)}dbd.shift_viewer_pixels=function(a,c){var b=(a/this.vw)*24*60;this.shift_viewer_by_minutes(-b,c)};dbd.shift_viewer_by_minutes=function(d,e){var c=d3.time.minute.offset(this.viewer_date,d);var a=d3.time.minute.offset(this.sdate,-0*(24*60));var b=d3.time.minute.offset(this.edate,0.5*(24*60));if(c<a){c=a}if(c>b){c=b}this.position_viewer_at(c,e)};dbd.relative_position=function(b){var d=this.edate.getTime();var c=this.sdate.getTime();var a=b.getTime();return((a-c)/(d-c))};dbd.relative_date=function(e){var d=this.edate.getTime();var c=this.sdate.getTime();var b=c+e*(d-c);var a=new Date;a.setTime(b);return a};dbd.position_viewer_at=function(b,d){this.viewer_date=b;b=d3.time.minute.offset(b,-12*60);var a=this.xscale_day(b);this.set_pan(-a,d);var c=this.relative_position(b);slider_set(c)};dbd.position_viewer_from_slider=function(c){var b=this.relative_date(c);this.viewer_date=b;b=d3.time.minute.offset(b,-12*60);var a=this.xscale_day(b);this.set_pan(-a,false)};dbd.set_date=function(b){b=midnight(b);d3.select("#db-edate").attr("value",friendly_date3(b));var a=d3.time.day.offset(b,-14);dashboard_clear();draw_dashboard(a,b)};function dbd_keydown(g,f){if(d3.event.metaKey&&d3.event.keyCode==69){dbd.eMode=!dbd.eMode;dashboard_clear();draw_dashboard(dbd.sdate,dbd.edate);return}if(dbd.mode=="scatter"){var e;var j=d3.event.keyIdentifier;if(j=="Right"){if(dbd.edate>=telemetry.maxDate){return}e=d3.time.day.offset(dbd.edate,7);if(e>telemetry.maxDate){e=telemetry.maxDate}dbd.set_date(e);return}if(j=="Left"){if(dbd.edate<=d3.time.day.offset(telemetry.minDate,14)){return}e=d3.time.day.offset(dbd.edate,-7);if(e<d3.time.day.offset(telemetry.minDate,14)){e=d3.time.day.offset(telemetry.minDate,14)}dbd.set_date(e);return}return}if(dbd.mode!="detail"){return}var j=d3.event.keyIdentifier;var h=0.5;if(d3.event.shiftKey){h=3}if(d3.event.ctrlKey){h=12}var b=new Date().getTime();if(dbd.last_keypress_time!=undefined){var a=b-dbd.last_keypress_time;if(a<500){dbd.continuous_clicks+=1}else{dbd.continuous_clicks=1}}else{dbd.continuous_clicks=1}dbd.last_keypress_time=b;var c=Math.round((dbd.continuous_clicks/2)-0.5)*2;h*=(c+1);if(j!=undefined){if(j=="Right"){dbd.shift_viewer_by_minutes(h*60,true)}if(j=="Left"){dbd.shift_viewer_by_minutes(-h*60,true)}}}dbd.click_to_detailed=function(a){dbd.set_mode("detail");dbd.position_viewer_at(a,false);select_tab("#detail_tab")};dbd.click_to_scatter=function(a){dbd.set_mode("scatter");select_tab("#day_tab")};dbd.eMode=false;dbd.init=function(i,t,b,e,p){if(this.ctip==undefined){this.ctip=CustomTooltip("message_tooltip",240)}else{this.ctip.hideTooltip()}var n=40;var f=45;var g=15;var m=4;var u=this.pad=20;var j=this.vw=e-f-2*u;var x=this.vh=p-n-(g+m);this.color_mode="simple";this.outer=i.append("svg").attr("width",e).attr("height",p);this.time_legend=this.outer.append("svg").attr("id","time-legend").attr("x",f).attr("y",0).attr("width",j+2*u).attr("height",n).append("g").attr("id","time-panner").attr("transform",fmt_translate(u,0));this.y_legend=this.outer.append("svg").attr("x",0).attr("y",n).attr("width",f).attr("height",x).append("g").attr("transform",fmt_translate(0,0));this.y_legend_width=f;this.inner=this.outer.append("svg").attr("x",f).attr("y",n).attr("width",j+2*u).attr("height",x).attr("id","dashboard-inner");var q=j+2*u;this.slider=this.outer.append("svg").attr("x",f).attr("y",n+x+4).attr("width",q).attr("height",g).attr("id","slider").attr("visibility","hidden");make_slider(this.slider,0,0,q,g,1/24);var l=this.hour_to_color(0);this.inner.append("rect").attr("x",0).attr("y",0).attr("width",j+2*u).attr("height",x).attr("fill",l);this.vis=this.inner.append("g").attr("id","pan-window").attr("transform",fmt_translate(0,0));this.sdate=t;this.edate=b;this.viewer_date=noon(b);var r=d3.time.day.offset(this.edate,1);this.dateRange=d3.time.days(this.sdate,r);var d=midnight(t);var c=midnight(r);this.xscale_hour=d3.scale.linear().domain([0,24]).range([0,j]);this.xscale_day=d3.scale.linear().domain([d,c]).range([0,j*14]);this.yscale_bg=d3.scale.linear().domain([40,360]).range([x,0]);var v=x/14;var a=v/2;this.yscale_day=d3.scale.linear().domain([d,c]).range([x,0]);this.yscale_vbg=d3.scale.linear().domain([40,360]).range([x/3,0]);this.yscale_carbs=d3.scale.linear().domain([0,200]).range([x/3,2*x/3]);this.yscale_insulin=d3.scale.linear().domain([0,9]).range([2*x/3,x/3]);this.yscale_basal=d3.scale.linear().domain([0,2]).range([x,2*x/3]);this.draw_ramp();this.draw_gray_spacer();this.draw_day_grid(-20,14*j);this.draw_bg_grid(-20,14*j);this.draw_vbg_grid(-20,14*j);this.draw_insulin_grid(-20,14*j);this.draw_time_legend();this.mode="none";var o=d3.behavior.drag().on("drag",dbd_dragmove);this.time_legend.call(o);d3.select(window).on("keydown",dbd_keydown);this.vis.on("xdblclick",function(w,h){if(dbd.mode=="detail"){dbd.click_to_scatter();return}var A=d3.svg.mouse(this)[1];var z=dbd.yscale_day.invert(A);var w=new Date();w.setTime(z);dbd.click_to_detailed(noon(w))}).on("mousedown",function(w,h){if(tooltip.item!=undefined){tooltip.lock()}}).on("mouseup",function(w,h){tooltip.break_lock()}).on("mousemove",function(w,h){tooltip.travel()});dscale=this.tscale};dbd.data=function(c,f,i,e){this.set_mode("scatter");this.vis.selectAll(".BG-low,.BG-normal,.BG-high,.carbs").remove();this.vis.selectAll(".basal,.bolus,.temp_basal").remove();this.draw_carbs(f);this.draw_bg(c);this.draw_bolus(i);this.draw_basal(e);this.draw_message(ts_dummy_message);var h=telemetry.find_isolated_highs(c,f,i);for(k in h){var l=h[k][0];var g=h[k][1];c[l].bg_bolus=i[g];i[g].bg=c[l]}var d=telemetry.find_covered_carbs(c,f,i);var b=d.length;for(k in d){var j=d[k][0];var g=d[k][1];f[j].carb_bolus=i[g];i[g].carb=f[j]}var a=telemetry.find_temp_basals(electra_program_jun2012,e);this.draw_temp_basal(a);this.vis.selectAll(".carbs").attr("visibility","hidden");this.vis.selectAll(".basal").attr("visibility","hidden");this.vis.selectAll(".bolus").attr("visibility","hidden")};var bg_arrow={half_width:8,height:12,notch:2};function gen_down_arrow(f){var b=dbd.xscale(f);var g=dbd.yscale(f);var c=bg_arrow;var e="M"+(b-c.half_width)+" "+(g-Math.round(c.height/2));e+="l"+c.half_width+" "+c.notch;e+="l"+c.half_width+" -"+c.notch;e+="l-"+c.half_width+" "+c.height;return e+"z"}function gen_up_arrow(f){var b=dbd.xscale(f);var g=dbd.yscale(f);var c=bg_arrow;var e="M"+(b-c.half_width)+" "+(g+Math.round(c.height/2));e+="l"+c.half_width+" -"+c.notch;e+="l"+c.half_width+" "+c.notch;e+="l-"+c.half_width+" -"+c.height;return e+"z"}function gen_message_bubble(b){var a=dbd.xscale_day(b.x);var c=dbd.yscale_insulin(0);return cartoon_bubble_path(a,c+3,16,10,6,3,3)}var s='<table class="table table-striped">';s+="<thead>";s+="<tr>";s+="<th> time </th>";s+="<th> old </th>";s+="<th> new </th>";s+="</tr>";s+="</thead>";s+="<tbody>";s+="<tr>";s+="<td> midnight </td>";s+="<td> 16 </td>";s+="<td> 16 </td>";s+="</tr>";s+="<tr>";s+="<td> 6am </td>";s+='<td class="highlight-table-entry"> 12 </td>';s+='<td class="highlight-table-entry"> 14 </td>';s+="</tr>";s+="<tr>";s+="<td> 10am </td>";s+="<td> 15 </td>";s+="<td> 15 </td>";s+="</tr>";s+="<tr>";s+="<td> 1pm </td>";s+="<td> 16 </td>";s+="<td> 16 </td>";s+="</tr>";s+="</tbody>";s+="</table>";var ts_dummy_message=[];var dummy_date=new Date("6/8/2012 12:44");var dummy_content="<h3>New I:C Ratio</h3><p>12:44pm Fri 6/8/12</p><p>Patient changed setting...</p>"+s;ts_dummy_message.push({x:dummy_date,y:dummy_content});var dummy_content2="<h3>from Steve...</h3><p>5:26pm Fri 7/6/12</p><p>The low from the meter seems to be an erroneous value... we treated it so Electra went high, but then corrected after we realized there was a bad reading</p>";ts_dummy_message.push({x:new Date("7/6/2012 17:26"),y:dummy_content2});dbd.draw_message=function(a){this.vis.selectAll(".message").data(a).enter().append("path").attr("d",function(b){return gen_message_bubble(b)}).attr("class","detailed_label").attr("opacity","0.65").attr("fill","white").attr("stroke","none").on("mouseover",function(f,b){var e=d3.select(this);var c=this.__data__.y;dbd.ctip.showTooltip(c,d3.event);d3.select(this).attr("stroke","black")}).on("mouseout",function(c,b){d3.select(this).attr("stroke","none");dbd.ctip.hideTooltip()})};dbd.draw_bg=function(d){if(dbd.eMode){this.vis.selectAll(".BG-normal").data(d).enter().append("circle").attr("class","BG-normal").attr("cx",function(e){return dbd.xscale_hour(get_hour(e.x))}).attr("cy",function(e){return dbd.yscale(e)}).attr("opacity","0.65").attr("r",function(e){return bg_to_radius(e.y)}).attr("fill",function(f,e){return bg_to_color(f.y)});dbd.set_bg_mouseover();return}var b=d.filter(function(e){return(e.y<80)});var c=d.filter(function(e){return(e.y>=80&&e.y<180)});var a=d.filter(function(e){return(e.y>=180)});this.vis.selectAll(".BG-low").data(b).enter().append("path").attr("d",function(e){return gen_down_arrow(e)}).attr("class","BG-low").attr("opacity","0.65").attr("stroke","white").attr("stroke-width","0.75px").attr("fill",function(f,e){return bg_to_simple_color(f.y)});this.vis.selectAll(".BG-high").data(a).enter().append("path").attr("d",function(e){return gen_up_arrow(e)}).attr("class","BG-high").attr("opacity","0.65").attr("stroke-width","0.75px").attr("fill",function(f,e){return bg_to_simple_color(f.y)}).attr("stroke",function(e){return(e.y<350)?"white":d3.rgb(255,0,255)});this.vis.selectAll(".BG-normal").data(c).enter().append("circle").attr("class","BG-normal").attr("cx",function(e){return dbd.xscale_hour(get_hour(e.x))}).attr("cy",function(e){return dbd.yscale(e)}).attr("r",8).attr("opacity","0.65").attr("stroke","white").attr("stroke-width","0.75px").attr("fill",function(f,e){return bg_to_simple_color(f.y)});dbd.set_bg_mouseover()};dbd.set_bg_mouseover=function(){d3.selectAll(".BG-low,.BG-normal,.BG-high").on("mouseover",function(c,a){var b=d3.select(this);tooltip.enable(b,format_time_bg_data(this.__data__));var c=this.__data__;if(c.y<70){shake_me(this)}if(dbd.mode=="detail"){if(c.bg_bolus!=undefined){dbd.draw_bg_bolus_association(c,c.bg_bolus)}}}).on("dblclick",function(c,a){if(dbd.mode=="detail"){dbd.click_to_scatter();return}var b=this.__data__.x;dbd.click_to_detailed(b)}).on("mouseup",function(b,a){tooltip.unlock()}).on("mouseout",function(b,a){tooltip.disable();stop_shaking()})};dbd.set_mode=function(b){if(b==this.mode){return}this.mode=b;d3.selectAll(".y_legend").remove();d3.selectAll(".bg_grid,.vbg_grid,.day_grid,.insulin_grid").attr("visibility","hidden");d3.selectAll(".detailed_label").attr("visibility","hidden");d3.select("#slider").attr("visibility","hidden");this.vis.selectAll(".carbs,.basal,.bolus").attr("visibility","hidden");var a=this;if(b=="scatter"){d3.selectAll(".day_grid").attr("visibility","visible");this.yscale=function(c){return a.yscale_day(noon(c.x))};this.draw_day_legend();this.xscale=function(c){return a.xscale_hour(get_hour(c.x))};this.set_pan(0,false)}else{if(b=="dist"){d3.selectAll(".bg_grid").attr("visibility","visible");this.draw_bg_legend();this.yscale=function(c){return a.yscale_bg(limit(c.y,40,350))};this.xscale=function(c){return a.xscale_hour(get_hour(c.x))};this.set_pan(0,false)}else{d3.selectAll(".vbg_grid,.insulin_grid").attr("visibility","visible");d3.selectAll(".detailed_label").attr("visibility","visible");d3.select("#slider").attr("visibility","visible");this.vis.selectAll(".carbs,.basal,.bolus").attr("visibility","visible");this.yscale=function(c){return a.yscale_vbg(limit(c.y,40,350))};this.xscale=function(c){return a.xscale_day(c.x)};this.draw_detail_legend();this.position_viewer_at(this.viewer_date,false)}}this.vis.selectAll(".BG-normal").transition().attr("cx",function(c){return dbd.xscale(c)}).attr("cy",function(c){return dbd.yscale(c)});this.vis.selectAll(".BG-high").transition().attr("d",function(c){return gen_up_arrow(c)});this.vis.selectAll(".BG-low").transition().attr("d",function(c){return gen_down_arrow(c)})};dbd.draw_day_grid=function(b,a){this.vis.selectAll(".day_grid").data(this.dateRange).enter().append("line").attr("class","day_grid").attr("stroke","#ccc").attr("stroke-width","1px").attr("opacity","0.25").attr("x1",b).attr("y1",function(c){return(dbd.yscale_day(c))}).attr("x2",a).attr("y2",function(c){return(dbd.yscale_day(c))})};dbd.draw_vbg_grid=function(c,a){var b=this;this.vis.selectAll(".vbg_grid").data([80,180]).enter().append("line").attr("class","vbg_grid").attr("stroke","#ccc").attr("stroke-dasharray","2,5").attr("stroke-width","1.5px").attr("opacity","0.2").attr("x1",c).attr("y1",function(e){return(b.yscale_vbg(e))}).attr("x2",a).attr("y2",function(e){return(b.yscale_vbg(e))});this.vis.append("line").attr("class","vbg_grid").attr("stroke","#ccc").attr("stroke-width","1.5px").attr("opacity","0.25").attr("x1",c).attr("y1",function(e){return(b.yscale_vbg(40))}).attr("x2",a).attr("y2",function(e){return(b.yscale_vbg(40))})};dbd.draw_insulin_grid=function(c,a){var b=this;this.vis.selectAll(".insulin_grid").data([0]).enter().append("line").attr("class","insulin_grid").attr("stroke","#ccc").attr("stroke-width","1.5px").attr("opacity","0.25").attr("x1",c).attr("y1",function(e){return(b.yscale_insulin(e))}).attr("x2",a).attr("y2",function(e){return(b.yscale_insulin(e))})};dbd.draw_bg_grid=function(b,a){this.vis.selectAll(".bg_grid").data([80,180]).enter().append("line").attr("class","bg_grid").attr("stroke","#ccc").attr("stroke-width","1px").attr("opacity","0.25").attr("x1",b).attr("y1",function(c){return(dbd.yscale_bg(c))}).attr("x2",a).attr("y2",function(c){return(dbd.yscale_bg(c))})};dbd.draw_day_legend=function(){this.y_legend.selectAll(".y_legend").remove();var b=this.y_legend_width/2;var c=8;var a=2;this.y_legend.selectAll("y_legend").data(this.dateRange).enter().append("text").attr("class","y_legend").attr("font-size","85%").attr("x",b).attr("y",function(e){return dbd.yscale_day(noon(e))-c+a}).attr("text-anchor","middle").text(function(e){return weekday(e)});this.y_legend.selectAll("y_legend2").data(this.dateRange).enter().append("text").attr("class","y_legend").attr("font-size","85%").attr("x",b).attr("y",function(e){return dbd.yscale_day(noon(e))+c+a}).attr("text-anchor","middle").text(function(e){return friendly_date4(e)})};dbd.draw_bg_legend=function(){var a=this.y_legend_width/2;this.y_legend.selectAll(".y_legend").remove();this.y_legend.selectAll("y_legend").data([40,60,80,100,120,140,160,180,200,220,240,260,280,300,320,340]).enter().append("text").attr("class","y_legend").attr("font-size","85%").attr("x",a).attr("y",function(b){return dbd.yscale_bg(b)}).attr("text-anchor","middle").text(function(b){return b})};dbd.draw_detail_legend=function(){var a=this.y_legend_width/2;this.y_legend.selectAll(".y_legend").remove();this.y_legend.selectAll("detail_bg_legend").data([60,100,140,180,220,260,300,340]).enter().append("text").attr("class","y_legend").attr("font-size","85%").attr("x",a).attr("y",function(b){return dbd.yscale_vbg(b)}).attr("text-anchor","middle").text(function(b){return b});this.y_legend.selectAll("detail_bolus_legend").data([1,2,3,4,5,6,7,8]).enter().append("text").attr("class","y_legend").attr("font-size","85%").attr("x",a).attr("y",function(b){return dbd.yscale_insulin(b)}).attr("text-anchor","middle").text(function(b){return b});this.y_legend.selectAll("detail_basal_legend").data([0.2,0.4,0.6,0.8,1,1.2,1.4,1.6,1.8]).enter().append("text").attr("class","y_legend").attr("font-size","85%").attr("x",a).attr("y",function(b){return dbd.yscale_basal(b)}).attr("text-anchor","middle").text(function(b){return b})};dbd.set_color_mode=function(a){if(dbd.color_mode==a){return}dbd.color_mode=a;if(dbd.color_mode=="simple"){this.vis.selectAll(".BG-low,.BG-normal,.BG-high").transition().attr("r",10).attr("fill",function(c,b){return bg_to_simple_color(c.y)})}else{this.vis.selectAll(".BG-low,.BG-normal,.BG-high").transition().attr("r",function(b){return bg_to_radius(b.y)}).attr("fill",function(c,b){return bg_to_color(c.y)})}};dbd.draw_carbs=function(a){var b=8;this.vis.selectAll("carbs").data(a).enter().append("rect").attr("class","carbs").attr("x",function(c){return dbd.xscale_day(c.x)-b/2}).attr("y",function(c){return dbd.yscale_carbs(0)}).attr("width",b).attr("height",function(c){return dbd.yscale_carbs(c.y)-dbd.yscale_carbs(0)}).attr("fill","lightpink").attr("stroke","white").attr("stroke-width","0.75px").attr("opacity","0.6").on("mouseover",function(f,c){var e=d3.select(this);var f=this.__data__;tooltip.enable(e,format_time_carb_data(f));if(dbd.mode=="detail"&&f.carb_bolus!=undefined){dbd.draw_carb_bolus_association(f,f.carb_bolus)}}).on("mouseup",function(e,c){tooltip.unlock()}).on("mouseout",function(e,c){tooltip.disable()})};function dbd_largest_date_smaller_than(e,b){var a=0;while(a<e.length){var c=e[a].x;if(c>b){return a-1}a=a+1}return e.length}function dbd_basal_invert(c,b){var a=dbd_largest_date_smaller_than(c,b);if(a<0||a>=c.length){return undefined}return[c[a],c[a+1]]}dbd.draw_basal=function(g){d3.selectAll(".basal").remove();var a=d3.svg.area().x(function(h){return dbd.xscale_day(h.x)}).y0(dbd.yscale_basal(0)).y1(function(h){return dbd.yscale_basal(h.y)}).interpolate("step-after");var f=d3.svg.area().x(function(h){return dbd.xscale_day(h.x)}).y0(dbd.yscale_basal(0)).y1(dbd.yscale_basal(0)).interpolate("step-after");var d=d3.svg.line().x(function(h){return dbd.xscale_day(h.x)}).y(function(h){return dbd.yscale_basal(h.y)}).interpolate("step-after");var c=this.vw;var b=this.vis;var e=b.append("svg:path").attr("class","basal").attr("fill","lightblue").attr("opacity","0.25").attr("d",a(g)).on("mousemove",function(r,l){var h=d3.svg.mouse(this);var p=h[0];var j=p/(c*14)*(24*14);var o=d3.time.minute.offset(dbd.sdate,j*60);span=dbd_basal_invert(g,o);var n=d3.select(this);var q=format_time_basal_data(span[0],span[1]);tooltip.enable(n,q)}).on("mouseup",function(j,h){tooltip.unlock()}).on("mouseout",function(j,h){tooltip.disable()});b.append("svg:path").attr("class","basal").attr("stroke","white").attr("stroke-dasharray","3,1").attr("fill","none").attr("d",d(g))};dbd.draw_bolus=function(a){var b=8;this.vis.selectAll("bolus").data(a).enter().append("rect").attr("class","bolus").attr("x",function(c){return dbd.xscale_day(c.x)-b/2}).attr("y",function(c){return dbd.yscale_insulin(c.y)}).attr("width",b).attr("height",function(c){return dbd.yscale_insulin(0)-dbd.yscale_insulin(c.y)}).attr("fill","lightblue").attr("stroke","white").attr("stroke-width","0.75px").attr("opacity","0.8").on("mouseover",function(f,c){var e=d3.select(this);tooltip.enable(e,format_time_insulin_data(this.__data__));var f=this.__data__;if(dbd.mode=="detail"){if(f.bg!=undefined){dbd.draw_bg_bolus_association(f.bg,f)}if(f.carb!=undefined){dbd.draw_carb_bolus_association(f.carb,f)}}}).on("mouseup",function(e,c){tooltip.unlock()}).on("mouseout",function(e,c){tooltip.disable()})};dbd.draw_bg_bolus_association=function(a,b){this.vis.append("line").attr("class","remove-with-tooltip").attr("x1",dbd.xscale_day(a.x)).attr("y1",dbd.yscale_vbg(a.y)+10).attr("x2",dbd.xscale_day(b.x)).attr("y2",dbd.yscale_insulin(b.y)-10).attr("stroke","#ccc").attr("stroke-width","1px").attr("stroke-dasharray","3,5").attr("opacity","1");this.vis.append("text").attr("class","remove-with-tooltip").attr("x",(dbd.xscale_day(a.x)+dbd.xscale_day(b.x))/2).attr("y",(dbd.yscale_insulin(b.y)+dbd.yscale_vbg(a.y))/2).attr("text-anchor","middle").attr("fill","white").text(format_time_ihigh_data(a,b))};dbd.draw_carb_bolus_association=function(a,b){this.vis.append("line").attr("class","remove-with-tooltip").attr("x1",dbd.xscale_day(a.x)).attr("y1",dbd.yscale_carbs(a.y)+10).attr("x2",dbd.xscale_day(b.x)).attr("y2",dbd.yscale_insulin(b.y)-10).attr("stroke","#ccc").attr("stroke-width","1px").attr("stroke-dasharray","3,5").attr("opacity","1");this.vis.append("text").attr("class","remove-with-tooltip").attr("x",(dbd.xscale_day(a.x)+dbd.xscale_day(b.x))/2).attr("y",(dbd.yscale_insulin(b.y)+dbd.yscale_carbs(a.y))/2).attr("text-anchor","middle").attr("fill","white").text(format_time_carb_cover(a,b))};dbd.draw_temp_basal=function(a){d3.selectAll(".temp_basal").remove();for(k in a){dbd.draw_one_temp_basal(a[k])}};dbd.draw_one_temp_basal=function(f){var a=d3.svg.area().x(function(g){return dbd.xscale_day(g.actual.x)}).y0(function(g){return dbd.yscale_basal(g.actual.y)}).y1(function(g){return dbd.yscale_basal(g.program)}).interpolate("step-after");var d=d3.svg.line().x(function(g){return dbd.xscale_day(g.actual.x)}).y(function(g){return dbd.yscale_basal(g.program)}).interpolate("step-after");var c=this.vw;var b=this.vis;var e=b.append("svg:path").attr("class","temp_basal").attr("fill","lightpink").attr("opacity","0.5").attr("d",a(f)).on("mousemove",function(p,n){var u=d3.select(this);var q=format_time(f[0].actual.x);var r=format_time(f[f.length-1].actual.x);var h="temp basal "+q+" to "+r;tooltip.enable(u,h);return;var j=d3.svg.mouse(this);var t=j[0];var l=t/(c*14)*(24*14);var g=d3.time.minute.offset(dbd.sdate,l*60);span=dbd_basal_invert(f,g);var o=d3.select(this);var h=format_time_basal_data(span[0],span[1]);tooltip.enable(o,h)}).on("mouseup",function(h,g){tooltip.unlock()}).on("mouseout",function(h,g){tooltip.disable()});return;b.append("svg:path").attr("class","temp_basal").attr("stroke","white").attr("stroke-dasharray","3,1").attr("fill","none").attr("d",d(f))};